<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin • Appointments</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f6f8fb; margin:0; }
    .wrap { max-width:980px; margin:36px auto; background:#fff; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); padding:20px; }
    h1 { margin:0 0 14px; font-size:22px; }
    .toolbar { display:flex; gap:10px; align-items:center; margin:12px 0 16px; }
    input, select, button { padding:8px 10px; border:1px solid #d9e0ea; border-radius:8px; background:#fff; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eef2f7; padding:10px 8px; text-align:left; font-size:14px; }
    th { background:#f9fbff; font-weight:700; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef4ff; color:#234; }
    .muted { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin Dashboard — Appointments</h1>

    <div class="toolbar">
      <label class="muted">Filter by date:</label>
      <input type="date" id="filterDate"/>
      <button id="clearFilter">Clear</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Queue #</th>
          <th>Date</th>
          <th>Time</th>
          <th>Patient</th>
          <th>Age</th>
          <th>Sex</th>
          <th>Phone</th>
          <th>Category</th>
          <th>Symptoms</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="10">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ✅ Updated Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAlQ2h3WdhMHVl9nwz_Ug3ejscxtWuEtlE",
      authDomain: "cho-clinic-default-rtdb.asia-southeast1.firebasedatabase.app",
      databaseURL: "https://cho-clinic-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cho-clinic-default-rtdb.asia-southeast1.firebasedatabase.app",
      storageBucket: "cho-clinic-default-rtdb.asia-southeast1.firebasedatabase.app",
      messagingSenderId: "420319378706",
      appId: "1:420319378706:web:6083b4ccd5338a7e9a07cb",
      measurementId: "G-S9XQE2SKFZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tbody = document.getElementById("rows");
    const filterDate = document.getElementById("filterDate");
    const clearBtn = document.getElementById("clearFilter");

    let all = [];

    function render() {
      const d = filterDate.value || null;
      let list = [...all];
      if (d) list = list.filter(x => x.date === d);

      // Sort: date asc, time asc
      list.sort((a,b) => {
        if (a.date === b.date) return a.time.localeCompare(b.time);
        return a.date.localeCompare(b.date);
      });

      tbody.innerHTML = list.length
        ? list.map(x => `
          <tr>
            <td><span class="badge">${x.queueNumber ?? "-"}</span></td>
            <td>${x.date}</td>
            <td>${x.time}</td>
            <td>${x.lastName}, ${x.firstName}</td>
            <td>${x.age}</td>
            <td>${x.sex}</td>
            <td>${x.phone}</td>
            <td>${x.symptomsCategory || "-"}</td>
            <td>${x.details || ""}</td>
          </tr>
        `).join("")
        : `<tr><td colspan="10">No appointments${d ? " for "+d : ""}.</td></tr>`;
    }

    function processSnapshot(snap) {
      all = [];
      if (snap.exists()) {
        snap.forEach(appt => {
          all.push(appt.val());
        });
      }
      render();
    }

    // Live updates
    onValue(ref(db, "appointments"), (snap) => {
      processSnapshot(snap);
    });

    // Fallback refresh every 30s
    setInterval(async () => {
      const snap = await get(ref(db, "appointments"));
      processSnapshot(snap);
    }, 30000);

    filterDate.addEventListener("change", render);
    clearBtn.addEventListener("click", () => { filterDate.value = ""; render(); });
  </script>
</body>
</html>
