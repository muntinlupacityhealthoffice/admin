<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Health Office - Appointment Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to bottom, #e0eaf3, #f0f4f8);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #ffd600;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .footer {
            background-color: #ffd600;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="privacyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-blue-400">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4 text-blue-800">Data Privacy Notice ðŸ‡µðŸ‡­</h3>
                <p class="text-gray-700 mb-6">
                    In compliance with the **Philippine Data Privacy Act of 2012 (RA 10173)**, we assure you that your personal information collected for this appointment is handled with the utmost care and security.
                </p>
                <p class="text-sm text-gray-600 mb-6">
                    Your data will be used solely for the purpose of processing your appointment and will not be shared with any unauthorized third parties. By proceeding, you consent to our privacy policy.
                </p>
                <button id="acknowledgePrivacy" class="w-full sm:w-auto px-6 py-2 bg-[#ffc107] text-gray-900 font-semibold rounded-full shadow-md hover:bg-[#ffa000] focus:outline-none focus:ring-2 focus:ring-[#ffc107] focus:ring-offset-2 transition-colors duration-200">
                    I Understand and Agree
                </button>
            </div>
        </div>
    </div>

    <header class="header border-b-4 border-blue-400">
        <div class="container flex flex-col sm:flex-row justify-center sm:justify-between items-center px-4 py-4">
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-6 text-center sm:text-left">
                <img src="https://i.ibb.co/L150B20/Screenshot-2025-09-08-224815.png" alt="City Health Logo" class="rounded-full w-28 h-28 shadow-lg">
                <div>
                    <h1 class="font-semibold text-xl text-gray-700">MUNTINLUPA</h1>
                    <h2 class="font-bold text-4xl">CITY HEALTH OFFICE</h2>
                </div>
            </div>
            <nav class="mt-4 sm:mt-0">
                <ul class="flex space-x-6 font-medium">
                    <li><a href="#" class="hover:text-gray-600">HOME</a></li>
                    <li><a href="#" class="hover:text-gray-600">ABOUT</a></li>
                    <li><a href="#" class="hover:text-gray-600">SERVICES</a></li>
                    <li><a href="#" class="hover:text-gray-600">CONTACT</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="py-12 px-4">
        <div class="container">
            <h2 class="text-3xl font-bold text-center mb-8">Set Appointment</h2>
            
            <div id="formContainer" class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-lg border-2 border-blue-400">
                <form id="appointmentForm">
                    <h3 class="text-xl font-semibold mb-4 text-center">Personal & Appointment Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name*</label>
                            <input type="text" id="lastName" name="lastName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">First Name*</label>
                            <input type="text" id="firstName" name="firstName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="middleName" class="block text-sm font-medium text-gray-700">Middle Name</label>
                            <input type="text" id="middleName" name="middleName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700">Age*</label>
                            <input type="number" id="age" name="age" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="sex" class="block text-sm font-medium text-gray-700">Sex*</label>
                            <select id="sex" name="sex" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="">--SELECT--</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email*</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number*</label>
                            <input type="tel" id="phone" name="phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="services" class="block text-sm font-medium text-gray-700">Services*</label>
                            <select id="services" name="services" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="">--SELECT--</option>
                                <option value="death_transfer_exhumation">Issuance and release of Death certificates, Transfer certificates or Authorization of exhumation remains</option>
                                <option value="water_laboratory">Water Laboratory</option>
                                <option value="checkup">General Consultation and Treatment</option>
                                <option value="medical_certificate">Issuance of medical Certificate</option>
                                <option value="sanitary_permit">Issuance of Sanitary Permit</option>
                                <option value="basic_laboratory">Basic Laboratory</option>
                                <option value="basic_xray">Basic x-ray</option>
                                <option value="vaccination">Vaccination</option>
                                <option value="dental">Dental</option>
                                <option value="others">Others</option>
                            </select>
                        </div>
                        <div>
                            <label for="healthCenter" class="block text-sm font-medium text-gray-700">Health Center*</label>
                            <select id="healthCenter" name="healthCenter" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="">--SELECT--</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="specificDetails" class="block text-sm font-medium text-gray-700">Specific Details*</label>
                        <textarea id="specificDetails" name="specificDetails" rows="4" required placeholder="e.g., Please describe your symptoms or the reason for your appointment in detail." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="preferredDate" class="block text-sm font-medium text-gray-700">Preferred Date*</label>
                            <input type="date" id="preferredDate" name="preferredDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </div>
                        <div>
                            <label for="preferredTime" class="block text-sm font-medium text-gray-700">Preferred Time*</label>
                            <select id="preferredTime" name="preferredTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="">--SELECT--</option>
                            </select>
                        </div>
                    </div>
                    <span id="availabilityMessage" class="block text-sm mt-1 mb-4"></span>
                    
                    <div class="text-center">
                        <button type="submit" id="submitButton" class="flex items-center justify-center w-full sm:w-auto px-6 py-2 bg-gray-400 text-gray-600 font-semibold rounded-full shadow-md transition-colors duration-200" disabled>
                            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Submit
                        </button>
                    </div>
                </form>
            </div>

            <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-blue-400">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">Confirm Your Appointment</h3>
                        <p class="text-gray-600 mb-6">Please review the details below before confirming.</p>
                        
                        <div id="confirmationDetails" class="text-left text-gray-800 space-y-2 mb-6 p-4 rounded-md bg-gray-50 border border-gray-200">
                        </div>

                        <div class="text-center bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p class="text-sm text-gray-700 font-semibold">Important</p>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">Please take a screenshot or photo of this confirmation page for your records.</p>
                        </div>
                        
                        <div class="flex justify-around space-x-4">
                            <button id="editButton" class="w-full px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-full shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition-colors duration-200">
                                Edit
                            </button>
                            <button id="confirmButton" class="w-full px-4 py-2 bg-[#ffc107] text-gray-900 font-semibold rounded-full shadow-md hover:bg-[#ffa000] focus:outline-none focus:ring-2 focus:ring-[#ffc107] focus:ring-offset-2 transition-colors duration-200">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="successMessage" class="hidden fixed inset-0 bg-green-500 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-green-400">
                    <div class="text-center">
                        <svg class="mx-auto h-16 w-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-2xl font-bold text-green-700 mt-4">Appointment Pending</h3>
                        <p class="text-gray-600 mt-2">Your appointment has been successfully submitted. Your queue number is:</p>
                        <p class="mt-4 text-3xl font-bold text-blue-800" id="queueNumberDisplay"></p>
                        <p class="mt-2 text-sm text-gray-600">A representative will confirm your appointment via email or phone call as soon as possible.</p>
                        <div class="mt-6">
                            <button onclick="window.location.reload();" class="w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors duration-200">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <p id="userIdDisplay" class="text-sm text-center text-gray-500 mt-4 hidden">User ID: <span id="userIdSpan"></span></p>

        </div>
    </main>

    <footer class="footer mt-12">
        <div class="container text-center text-gray-800 font-medium">
            MUNTINLUPA CITY HEALTH OFFICE
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // This is a global variable provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        setLogLevel('Debug');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;

        const healthCenterData = {
            "city_health_office": { name: "CITY HEALTH OFFICE", services: ["death_transfer_exhumation", "water_laboratory", "checkup", "medical_certificate", "sanitary_permit", "basic_laboratory", "basic_xray", "vaccination", "dental", "others"] },
            "tunasan": { name: "TUNASAN HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "victoria": { name: "VICTORIA HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination", "others"] },
            "laguerta": { name: "LAGUERTA HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "poblacion": { name: "POBLACION HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination", "others"] },
            "southville": { name: "SOUTHVILLE HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "putatan": { name: "PUTATAN HEALTH CENTER", services: ["checkup", "medical_certificate", "sanitary_permit", "vaccination", "others"] },
            "putatan_annex": { name: "PUTATAN ANNEX HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "lakeview": { name: "LAKEVIEW HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination", "others"] },
            "bayan_main": { name: "BAYANAN MAIN HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "alabang": { name: "ALABANG HEALTH CENTER", services: ["checkup", "medical_certificate", "sanitary_permit", "vaccination", "others"] },
            "ayala_alabang": { name: "AYALA ALABANG HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "cupang": { name: "CUPANG HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination", "others"] },
            "sitio_sto_nino": { name: "SITIO STO. NINO HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "buli": { name: "BULI HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination", "others"] },
            "sucat": { name: "SUCAT HEALTH CENTER", services: ["checkup", "medical_certificate", "dental", "others"] },
            "bagong_silang": { name: "BAGONG SILANG HEALTH CENTER", services: ["checkup", "medical_certificate", "vaccination", "others"] }
        };

        // Authenticate the user anonymously
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userIdSpan').textContent = userId;
                document.getElementById('userIdDisplay').classList.remove('hidden');
                console.log("Authenticated with user ID:", userId);
                // Now that the user is authenticated, initialize the form logic.
                initializeFormLogic();
            } else {
                console.log("Signing in anonymously...");
                await signInAnonymously(auth);
            }
        });

        // This function contains all the form logic and event listeners.
        // It will be called only after the user is authenticated.
        const initializeFormLogic = () => {
            const servicesSelect = document.getElementById('services');
            const healthCenterSelect = document.getElementById('healthCenter');
            const appointmentForm = document.getElementById('appointmentForm');
            const preferredDateInput = document.getElementById('preferredDate');
            const preferredTimeSelect = document.getElementById('preferredTime');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationDetails = document.getElementById('confirmationDetails');
            const editButton = document.getElementById('editButton');
            const confirmButton = document.getElementById('confirmButton');
            const successMessage = document.getElementById('successMessage');
            const formContainer = document.getElementById('formContainer');
            const availabilityMessage = document.getElementById('availabilityMessage');
            const submitButton = document.getElementById('submitButton');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // Privacy modal elements
            const privacyModal = document.getElementById('privacyModal');
            const acknowledgePrivacyButton = document.getElementById('acknowledgePrivacy');

            // Function to set the minimum date to tomorrow
            const setMinDate = () => {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const year = tomorrow.getFullYear();
                const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const day = String(tomorrow.getDate()).padStart(2, '0');
                
                preferredDateInput.setAttribute('min', `${year}-${month}-${day}`);
            };

            // Function to generate time slots
            const generateTimeSlots = () => {
                preferredTimeSelect.innerHTML = '<option value="">--SELECT--</option>';
                const startTime = 8 * 60; // 8:00 AM in minutes
                const endTime = 17 * 60; // 5:00 PM in minutes
                const slotDuration = 30; // 30 minutes

                let currentTime = startTime;
                while (currentTime <= endTime) {
                    const hours = Math.floor(currentTime / 60);
                    const minutes = currentTime % 60;
                    
                    const formattedHours = String(hours).padStart(2, '0');
                    const formattedMinutes = String(minutes).padStart(2, '0');
                    const timeString = `${formattedHours}:${formattedMinutes}`;
                    
                    const option = document.createElement('option');
                    option.value = timeString;
                    option.textContent = timeString;
                    preferredTimeSelect.appendChild(option);
                    
                    currentTime += slotDuration;
                }
            };
            
            // Function to filter health centers based on selected service
            const filterHealthCentersByService = () => {
                const selectedService = servicesSelect.value;
                healthCenterSelect.innerHTML = '<option value="">--SELECT--</option>';
                
                if (selectedService) {
                    for (const key in healthCenterData) {
                        if (healthCenterData[key].services.includes(selectedService)) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = healthCenterData[key].name;
                            healthCenterSelect.appendChild(option);
                        }
                    }
                }
            };

            // This function checks for availability and enables/disables the submit button.
            const checkAvailability = async () => {
                const healthCenter = healthCenterSelect.value;
                const date = preferredDateInput.value;
                const time = preferredTimeSelect.value;
                
                // Reset availability message and button state
                availabilityMessage.textContent = '';
                submitButton.disabled = true;
                submitButton.classList.remove('bg-[#ffc107]', 'text-gray-900', 'hover:bg-[#ffa000]', 'focus:ring-[#ffc107]', 'focus:ring-offset-2');
                submitButton.classList.add('bg-gray-400', 'text-gray-600');
                loadingSpinner.classList.add('hidden');

                if (!healthCenter || !date || !time) {
                    return;
                }

                loadingSpinner.classList.remove('hidden');

                // Query Firestore for appointments with the selected health center, date, and time.
                const appointmentsRef = collection(db, `artifacts/${appId}/public/data/appointments`);
                const q = query(appointmentsRef, 
                    where("healthCenter", "==", healthCenter),
                    where("preferredDate", "==", date),
                    where("preferredTime", "==", time)
                );
                
                try {
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        availabilityMessage.textContent = 'This time slot is available.';
                        availabilityMessage.className = 'text-sm mt-1 text-green-600 font-semibold';
                        submitButton.disabled = false;
                        submitButton.classList.remove('bg-gray-400', 'text-gray-600');
                        submitButton.classList.add('bg-[#ffc107]', 'text-gray-900', 'hover:bg-[#ffa000]', 'focus:ring-[#ffc107]', 'focus:ring-offset-2');
                    } else {
                        availabilityMessage.textContent = 'This time slot is already booked. Please choose another one.';
                        availabilityMessage.className = 'text-sm mt-1 text-red-500 font-semibold';
                    }
                } catch (error) {
                    console.error("Error checking availability:", error);
                    availabilityMessage.textContent = 'An error occurred. Please try again.';
                    availabilityMessage.className = 'text-sm mt-1 text-red-500 font-semibold';
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            };

            // Initial setup
            setMinDate();
            generateTimeSlots();
            privacyModal.classList.remove('hidden');

            // Handle privacy acknowledgment
            acknowledgePrivacyButton.addEventListener('click', () => {
                privacyModal.classList.add('hidden');
            });

            // Listen for changes on the service select to filter health centers
            servicesSelect.addEventListener('change', () => {
                filterHealthCentersByService();
                checkAvailability();
            });

            // Listen for changes on the time, date, and health center inputs
            preferredDateInput.addEventListener('change', checkAvailability);
            preferredTimeSelect.addEventListener('change', checkAvailability);
            healthCenterSelect.addEventListener('change', checkAvailability);

            // Handle "Submit" button click (shows confirmation modal)
            appointmentForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (appointmentForm.checkValidity()) {
                    // Collect all form data
                    const allData = {};
                    new FormData(appointmentForm).forEach((value, key) => allData[key] = value);

                    // Populate confirmation modal with details
                    const selectedHealthCenter = healthCenterData[allData.healthCenter].name;
                    const selectedService = servicesSelect.options[servicesSelect.selectedIndex].text;
                    confirmationDetails.innerHTML = `
                        <p><strong class="font-semibold">Full Name:</strong> ${allData.firstName} ${allData.middleName} ${allData.lastName}</p>
                        <p><strong class="font-semibold">Age:</strong> ${allData.age}</p>
                        <p><strong class="font-semibold">Sex:</strong> ${allData.sex}</p>
                        <p><strong class="font-semibold">Email:</strong> ${allData.email}</p>
                        <p><strong class="font-semibold">Phone:</strong> ${allData.phone}</p>
                        <p><strong class="font-semibold">Service:</strong> ${selectedService}</p>
                        <p><strong class="font-semibold">Health Center:</strong> ${selectedHealthCenter}</p>
                        <p><strong class="font-semibold">Specific Details:</strong> ${allData.specificDetails}</p>
                        <p><strong class="font-semibold">Date:</strong> ${allData.preferredDate}</p>
                        <p><strong class="font-semibold">Time:</strong> ${allData.preferredTime}</p>
                    `;

                    // Hide the form and show the modal
                    formContainer.classList.add('hidden');
                    confirmationModal.classList.remove('hidden');
                } else {
                    appointmentForm.reportValidity();
                }
            });

            // Handle "Edit" button click on confirmation modal
            editButton.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                formContainer.classList.remove('hidden');
            });

            // Handle "Confirm" button click on confirmation modal (final submission)
            confirmButton.addEventListener('click', async () => {
                const allData = {};
                new FormData(appointmentForm).forEach((value, key) => allData[key] = value);
                
                try {
                    const appointmentsCollection = collection(db, `artifacts/${appId}/public/data/appointments`);
                    
                    // Add the appointment data to Firestore
                    const newAppointmentRef = await addDoc(appointmentsCollection, {
                        ...allData,
                        readableId: `appt-${Math.floor(Math.random() * 10000)}`,
                        status: "pending",
                        timestamp: new Date().toISOString(),
                        userId: userId
                    });

                    // Listen for changes to the entire appointments collection to get the queue number
                    onSnapshot(appointmentsCollection, (snapshot) => {
                        const allAppointments = snapshot.docs.map(doc => doc.data());
                        const activeAppointments = allAppointments.filter(appt => appt.status !== 'Cancelled');
                        
                        const queueNumber = activeAppointments.length;
                        document.getElementById('queueNumberDisplay').textContent = queueNumber;
                    });
                    
                    console.log("Appointment added with ID:", newAppointmentRef.id);
                    confirmationModal.classList.add('hidden');
                    successMessage.classList.remove('hidden');

                } catch (error) {
                    console.error("Error saving appointment: ", error);
                    const errorMessageModal = document.createElement('div');
                    errorMessageModal.innerHTML = `
                        <div class="fixed inset-0 bg-red-500 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                            <div class="relative p-8 bg-white w-full max-w-lg mx-auto rounded-2xl shadow-xl border-2 border-red-400">
                                <div class="text-center">
                                    <h3 class="text-2xl font-bold text-red-700 mt-4">Error</h3>
                                    <p class="text-gray-600 mt-2">An error occurred while saving your appointment. Please try again.</p>
                                    <div class="mt-6">
                                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove();" class="w-full px-4 py-2 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(errorMessageModal);
                }
            });
        };
    </script>
</body>
</html>
